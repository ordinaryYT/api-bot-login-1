<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fortnite Bot Controller</title>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    <style>
        /* [Previous CSS styles remain exactly the same] */
    </style>
</head>
<body>
    <!-- [Previous HTML structure remains exactly the same] -->

    <script>
        // Initialize EmailJS
        (function() {
            emailjs.init("Js8Z6hkbFnkcttBbT");
        })();

        // DOM Elements
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const statusMessage = document.getElementById('statusMessage');
        const botStatusElements = Array.from({length: 10}, (_, i) => document.getElementById(`bot${i+1}-status`));

        // API Configuration
        const API_BASE_URL = 'http://localhost:3000';
        const API_HEADERS = {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        };

        // Enhanced bot control functions
        async function startBots() {
            startButton.disabled = true;
            stopButton.disabled = false;
            statusMessage.textContent = 'Starting bots... This may take 5-20 minutes.';
            statusMessage.className = 'status active';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/bots/start`, {
                    method: 'POST',
                    headers: API_HEADERS,
                    credentials: 'include'
                });

                // Handle response
                if (!response.ok) {
                    const errorText = await response.text();
                    try {
                        const errorData = JSON.parse(errorText);
                        throw new Error(errorData.message || 'Failed to start bots');
                    } catch {
                        throw new Error(errorText || 'Failed to start bots');
                    }
                }

                const data = await response.json();
                
                // Update UI
                statusMessage.textContent = data.message || 'Bots started successfully!';
                statusMessage.className = 'status active success';
                startButton.textContent = 'Bots Running';
                updateBotStatuses(data.status.bots);
                
                // Send notification
                await sendNotification(`Bots started at: ${new Date().toLocaleString()}`);
                
            } catch (error) {
                handleError(error, 'starting');
                startButton.disabled = false;
                startButton.textContent = 'Start Bots';
            }
        }

        async function stopBots() {
            startButton.disabled = false;
            stopButton.disabled = true;
            statusMessage.textContent = 'Stopping bots...';
            statusMessage.className = 'status active';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/bots/stop`, {
                    method: 'POST',
                    headers: API_HEADERS,
                    credentials: 'include'
                });

                // Handle response
                if (!response.ok) {
                    const errorText = await response.text();
                    try {
                        const errorData = JSON.parse(errorText);
                        throw new Error(errorData.message || 'Failed to stop bots');
                    } catch {
                        throw new Error(errorText || 'Failed to stop bots');
                    }
                }

                const data = await response.json();
                
                // Update UI
                statusMessage.textContent = data.message || 'Bots stopped successfully!';
                statusMessage.className = 'status active success';
                startButton.textContent = 'Start Bots';
                updateBotStatuses(data.status.bots);
                
                // Send notification
                await sendNotification(`Bots stopped at: ${new Date().toLocaleString()}`);
                
            } catch (error) {
                handleError(error, 'stopping');
                stopButton.disabled = false;
            }
        }

        // Helper functions
        function updateBotStatuses(bots) {
            bots.forEach((bot, index) => {
                if (index < botStatusElements.length) {
                    const element = botStatusElements[index];
                    if (bot.status === 'active') {
                        element.classList.add('active');
                    } else {
                        element.classList.remove('active');
                    }
                }
            });
        }

        async function sendNotification(message) {
            try {
                await emailjs.send("service_lglu81w", "template_zplkxfb", {
                    to_email: "baileyksmith2010@gmail.com",
                    message: message
                });
            } catch (emailError) {
                console.error('Failed to send email:', emailError);
            }
        }

        function handleError(error, action) {
            console.error(`Error ${action} bots:`, error);
            statusMessage.textContent = `Error ${action} bots: ${error.message}`;
            statusMessage.className = 'status active error';
            sendNotification(`Error ${action} bots: ${error.message}`);
        }

        // Check initial bot status
        async function initialize() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/bots/status`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to check bot status');
                }

                const data = await response.json();
                
                if (data.status && data.status.running) {
                    startButton.disabled = true;
                    stopButton.disabled = false;
                    startButton.textContent = 'Bots Running';
                    updateBotStatuses(data.status.bots);
                }
            } catch (error) {
                console.error('Initialization error:', error);
                statusMessage.textContent = 'Error connecting to server. Make sure it is running.';
                statusMessage.className = 'status active error';
            }
        }

        // Event listeners
        startButton.addEventListener('click', startBots);
        stopButton.addEventListener('click', stopBots);

        // Initialize
        initialize();
    </script>
</body>
</html>